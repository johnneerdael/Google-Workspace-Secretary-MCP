{% if mode == 'new' %}
<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" 
     x-data="{ sending: false }"
     @keydown.escape.window="$el.remove()">
{% else %}
<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" 
     x-data="{ sending: false }"
     @keydown.escape.window="$el.remove()">
{% endif %}
    <div class="bg-gray-900 rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] flex flex-col">
        <div class="flex items-center justify-between px-4 py-3 border-b border-gray-800">
            <h2 class="text-lg font-semibold text-white">
                {% if mode == 'new' %}New Message
                {% elif mode == 'reply' %}Reply
                {% elif mode == 'reply_all' %}Reply All
                {% elif mode == 'forward' %}Forward
                {% endif %}
            </h2>
            <button @click="$el.closest('.fixed').remove()" 
                    class="text-gray-400 hover:text-white p-1">
                âœ•
            </button>
        </div>
        
        <form hx-post="/api/email/send" 
              hx-swap="none"
              hx-on::before-request="sending = true"
              hx-on::after-request="if(event.detail.successful) { $el.closest('.fixed').remove(); window.showToast('Email sent!', 'success'); } else { sending = false; window.showToast('Failed to send', 'error'); }"
              class="flex flex-col flex-1 overflow-hidden">
            
            {% if original_message_id %}
            <input type="hidden" name="reply_to_message_id" value="{{ original_message_id }}">
            {% endif %}
            
            <div class="px-4 py-2 space-y-2 border-b border-gray-800">
                <div class="flex items-center">
                    <label class="w-16 text-sm text-gray-400">To:</label>
                    <input type="email" name="to" value="{{ to }}" required
                           class="flex-1 bg-transparent text-white text-sm focus:outline-none placeholder-gray-600"
                           placeholder="recipient@example.com">
                </div>
                <div class="flex items-center">
                    <label class="w-16 text-sm text-gray-400">Cc:</label>
                    <input type="text" name="cc" value="{{ cc }}"
                           class="flex-1 bg-transparent text-white text-sm focus:outline-none placeholder-gray-600"
                           placeholder="cc@example.com">
                </div>
                <div class="flex items-center" x-data="{ showBcc: false }">
                    <template x-if="!showBcc">
                        <button type="button" @click="showBcc = true" 
                                class="text-sm text-gray-500 hover:text-gray-300">
                            + Bcc
                        </button>
                    </template>
                    <template x-if="showBcc">
                        <div class="flex items-center w-full">
                            <label class="w-16 text-sm text-gray-400">Bcc:</label>
                            <input type="text" name="bcc" value="{{ bcc }}"
                                   class="flex-1 bg-transparent text-white text-sm focus:outline-none placeholder-gray-600"
                                   placeholder="bcc@example.com">
                        </div>
                    </template>
                </div>
                <div class="flex items-center">
                    <label class="w-16 text-sm text-gray-400">Subject:</label>
                    <input type="text" name="subject" value="{{ subject }}" required
                           class="flex-1 bg-transparent text-white text-sm focus:outline-none placeholder-gray-600"
                           placeholder="Subject">
                </div>
            </div>
            
            <div class="flex-1 overflow-auto p-4">
                <textarea name="body" 
                          class="w-full h-full min-h-[300px] bg-transparent text-white text-sm focus:outline-none resize-none placeholder-gray-600"
                          placeholder="Write your message...">{{ body }}</textarea>
            </div>
            
            <div class="flex items-center justify-between px-4 py-3 border-t border-gray-800">
                <div class="flex items-center space-x-2">
                    <button type="button" 
                            class="p-2 text-gray-400 hover:text-white hover:bg-gray-800 rounded"
                            title="Attach file (coming soon)" disabled>
                        ðŸ“Ž
                    </button>
                </div>
                <div class="flex items-center space-x-2">
                    <button type="button" 
                            @click="$el.closest('.fixed').remove()"
                            class="px-4 py-2 text-sm font-medium text-gray-300 hover:text-white">
                        Cancel
                    </button>
                    <button type="submit" 
                            :disabled="sending"
                            class="px-4 py-2 text-sm font-medium text-white bg-primary rounded-md hover:bg-primary/90 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span x-show="!sending">Send</span>
                        <span x-show="sending">Sending...</span>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
